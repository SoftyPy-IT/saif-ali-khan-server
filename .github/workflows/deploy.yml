name: Node.js Deployment with NGINX and SSL

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH Client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Deploy to VPS using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            echo "Starting deployment to VPS..."

            # Navigate to the project directory
            cd /var/www/html/saifalikhan/saif-ali-khan-server || exit

            # Ensure Git is installed
            if ! command -v git &> /dev/null; then
              echo "Git is not installed. Installing..."
              sudo apt-get update
              sudo apt-get install -y git
            fi

            echo "Fetching latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main

            echo "Setting up environment variables..."
            if [ ! -f .env ]; then
              echo ".env file not found. Copying from .env.example..."
              cp .env.example .env
            fi

            echo "Installing dependencies..."
            npm install

            echo "Building Next.js application..."
            npm run build

            echo "Restarting application using PM2 on port 9003..."
            export PORT=9003
            pm2 restart saif-server || pm2 start npm --name "saif-server" -- run start

            echo "Saving PM2 process list..."
            pm2 save

            echo "Reloading NGINX..."
            sudo systemctl reload nginx

            echo "Deployment completed successfully!"
